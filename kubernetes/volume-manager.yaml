# from https://github.com/longhorn/longhorn/issues/3473#issuecomment-2001928894

apiVersion: v1
kind: Pod
metadata:
  name: volman
spec:
  containers:
    - image: docker.io/library/alpine:latest
      name: volman
      command:
        - /bin/sh
        - -c
      args: # see kubernetes/apps/rook-ceph/rook-ceph/cluster/helmrelease.yaml -> spec.values.cephClusterSpec.storage.devicePathFilter, this needs to be the exact same regex!
        - |
          apk add --no-cache findutils nvme-cli;
          DISK=$(find /dev/disk/by-id/ -regextype posix-extended -regex "^/dev/disk/by-id/(ata-SPCC_M.2_SSD_SP|nvme-SPCC_M.2_PCIe_SSD_FF).*" -not -name "*_[0-9]" -not -name "*-part[0-9]");
          echo "=== Wiping $DISK ===";
          nvme format --lbaf=1 $DISK --force;
          nvme format --block-size=4096 $DISK --force;
      volumeMounts:
        - mountPath: /dev/disk
          name: old
        - mountPath: /data/new
          name: new
  volumes:
    - name: old
      hostPath:
        path: /dev/disk
    - name: new
      hostPath:
        path: /
  dnsPolicy: ClusterFirst
  restartPolicy: Always
# kubectl scale -n namespace sts sts-name --replicas=0
# kubectl apply -f volume-manager.yaml -n namespace
# kubectl exec -ti myvolman -n namespace -- /bin/sh
# cp -a /data/old/. data/new/
# kubectl delete pod myvolman -n namespace
# kubectl scale -n namespace sts sts-name --replicas=1
